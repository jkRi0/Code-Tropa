<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Intro</title>
    <style>
        /* Global Styles */
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
            background-color: rgb(255, 255, 255); /* Full black background */
            color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Hide scrollbars */
        }

        /* Intro Screen Styles */
        .intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            color: white;
            font-family: Arial, sans-serif;
            transition: opacity 1s ease-out;
        }

        .intro-text-container {
            text-align: center;
            margin-bottom: 50px;
        }

        .intro-main-text {
            font-size: 3em; /* Adjust as needed for impact */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .intro-main-text.show {
            opacity: 1;
        }

        .intro-next-text {
            position: absolute;
            bottom: 30px;
            right: 30px;
            font-size: 1.2em;
            opacity: 0;
            transition: opacity 0.1s ease-in-out;
        }

        .intro-next-text.show {
            opacity: 1;
        }



        .startBG{
            background-color: wheat;
            width: 100vw;
            height: 100vh;
        }

        .chapter-intro-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher z-index than intro-screen */
            color: white;
            font-family: Arial, sans-serif;
            opacity: 0; /* Initially hidden */
            visibility: hidden; /* Ensure it's not interactive */
            transition: opacity 1s ease-out;
            cursor: pointer;
        }

        .chapter-text-container {
            text-align: center;
        }

        .main-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out;
        }

        .main-bg.show {
            opacity: 1;
            visibility: visible;
        }

        .main-bg img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: blur(10px);
        }

        .scene-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999; /* Below intro screens */
            color: white;
            font-family: Arial, sans-serif;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out;
            cursor: pointer;
        }

        .scene-content {
            width: 100%; /* Fill the width */
            height: 100%; /* Fill the height */
            object-fit: cover; /* Cover the entire container */
        }

        .subtitle-container {
            position: absolute;
            bottom: 20px;
            width: 80%;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            text-align: center;
            font-size: 2.3em; /* Enlarged font size */
            border-radius: 5px;
        }

        .scene-next-text {
            position: absolute;
            top: 10px; /* Adjust as needed to be above subtitle */
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.2em;
            opacity: 0;
            transition: opacity 0.1s ease-in-out, background-color 0.3s ease, color 0.3s ease;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .scene-text-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0);
            color: white;
            padding: 30px;
            /* border-radius: 15px; */
            font-size: 3em;
            max-width: 80%;
            line-height: 1.6;
            /* border: 2px solid rgba(255, 255, 255, 0.3); */
            /* box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); */
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .scene-text-overlay.show {
            opacity: 1;
        }

        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: white;
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .scene-next-text.show {
            opacity: 1;
        }

        .scene-next-text.highlight {
            background-color: rgba(105, 211, 57, 0.562); /* Subtle highlight */
            color: #fff;
        }

        .chapter-main-text {
            font-size: 7em; /* Big Font for Chapter */
            margin: 0;
        }

        .episode-sub-text {
            font-size: 3em; /* Small Font for Episode */
            margin: 0;
            opacity: 1; /* Make it visible */
            /* transition: opacity 1s ease-in; */ /* Remove ease-in transition */
        }

        /* Challenge Container Styles */
        .challenge-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1002; /* Above everything */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out;
        }

        .challenge-container.show {
            opacity: 1;
            visibility: visible;
        }

        .challenge-paper {
            background-image: url('assets/paper.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 100vw;
            height: 100vh;
            /* max-width: 100%;
            max-height: 100%; */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 60px 80px 40px 80px;
            box-sizing: border-box;
            overflow: hidden;
        }

        .challenge-title {
            font-size: 3.5em;
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-weight: bold;
        }

        .challenge-subtitle {
            font-size: 1.8em;
            color: #666;
            margin-bottom: 40px;
            text-align: center;
        }

        .question-container {
            width: 100%;
            margin-bottom: 30px;
        }

        .question-number {
            font-size: 1.8em;
            color: #333;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.3em;
            color: #333;
        }

        .option:hover {
            background-color: rgba(255, 255, 255, 0.9);
            border-color: #4CAF50;
        }

        .option.selected {
            background-color: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .option.correct {
            background-color: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .option.incorrect {
            background-color: #f44336;
            color: white;
            border-color: #da190b;
        }

        .option-letter {
            font-weight: bold;
            margin-right: 15px;
            min-width: 25px;
            font-size: 1.1em;
            color: #4CAF50;
        }

        .challenge-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        /* Story mode buttons styled like challenges modal buttons */
        .story-btn-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .story-btn {
            height: 50px;
            display: flex;
            background-color: rgba(249, 201, 143, 0);
            justify-content: center;
            transition: 0.3s ease;
            align-items: center;
            cursor: pointer;
            border: none;
            padding: 0;
        }

        .story-btn-inner {
            height: 80%;
            width: 100%;
            background-color: rgba(127, 255, 212, 0);
            position: relative;
            padding: 4px;
            margin-left: 30px;
            margin-right: 30px;
            border-radius: 8px;
        }

        .story-btn-top-border {
            width: 100%;
            height: 2px;
            background-color: #ffc107;
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 4px 4px 0 0;
        }

        .story-btn-bottom-border {
            width: 100%;
            height: 2px;
            background-color: #ffc107;
            position: absolute;
            bottom: 0;
            left: 0;
            border-radius: 0 0 4px 4px;
        }

        .story-btn-text {
            width: 100%;
            height: 100%;
            background-color: rgb(0, 0, 0);
            text-align: center;
            align-content: center;
            font-size: 1rem;
            color: white;
            position: relative;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .story-btn:hover {
            scale: 1.1;
        }

        /* Exit button styling */
        .exit-btn .story-btn-top-border,
        .exit-btn .story-btn-bottom-border {
            background-color: #6c757d;
        }

        .exit-btn .story-btn-text {
            background-color: #6c757d;
        }

        /* Action button styling (retry/next) */
        .action-btn .story-btn-top-border,
        .action-btn .story-btn-bottom-border {
            background-color: #ffc107;
        }

        .action-btn .story-btn-text {
            background-color: #000;
            color: white;
        }

        .challenge-btn {
            padding: 15px 35px;
            border: none;
            border-radius: 25px;
            font-size: 1.4em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .submit-btn {
            background-color: #4CAF50;
            color: white;
        }

        .submit-btn:hover {
            background-color: #45a049;
        }

        .submit-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .next-btn {
            background-color: #2196F3;
            color: white;
        }

        .next-btn:hover {
            background-color: #1976D2;
        }

        .results-container {
            text-align: center;
            margin-top: 20px;
        }

        .score-display {
            font-size: 2.8em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .points-earned {
            font-size: 2em;
            color: #333;
            margin-bottom: 30px;
        }

        .end-episode-btn {
            background-color: #FF9800;
            color: white;
            padding: 18px 45px;
            font-size: 1.6em;
        }

        .end-episode-btn:hover {
            background-color: #F57C00;
        }

        .exit-btn {
            background-color: #f44336;
            color: white;
            padding: 15px 30px;
            font-size: 1.2em;
            margin-left: 20px;
        }

        .exit-btn:hover {
            background-color: #da190b;
        }

        /* Badge display styling */
        .badge-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            padding: 20px;
        }

        .badge-display {
            background: linear-gradient(135deg, #dfe5ff 0%, #b5a7c3 100%);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
        }

        .badge-image {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
            animation: badgeGlow 2s ease-in-out infinite alternate;
        }

        @keyframes badgeGlow {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        .badge-text h3 {
            color: #000000;
            font-size: 1.8em;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .badge-text p {
            color: #000000;
            font-size: 1.2em;
            margin: 0 0 20px 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .badge-ok-btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .badge-ok-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        /* Responsive font sizes for mobile */
        @media (max-width: 768px) {
            .challenge-paper {
                overflow-y: auto;
                overflow-x: hidden;
            }
            
            .challenge-title {
                font-size: 2.5em;
            }
            
            .challenge-subtitle {
                font-size: 1.2em;
            }
            
            .question-number {
                font-size: 1.3em;
            }
            
            .question-text {
                font-size: 1.1em;
            }
            
            .option {
                font-size: 1em;
                padding: 10px 15px;
            }
            
            .challenge-btn {
                font-size: 1.1em;
                padding: 12px 30px;
            }
            
            .score-display {
                font-size: 2em;
            }
            
            .points-earned {
                font-size: 1.5em;
            }
            
            .end-episode-btn {
                font-size: 1.2em;
                padding: 15px 40px;
            }
        }
    </style>
</head>
<body>
    <div class="main-bg"><img src="assets/12.png" alt="Background Image"></div>
    <div class="challenge-container" id="challengeContainer">
        <div class="challenge-paper">
            <h2 class="challenge-title">Challenge Time!</h2>
            <p class="challenge-subtitle">Test your Java knowledge - 20 points each, total of 100 points</p>
            
            <div id="questionsContainer">
                <!-- Questions will be dynamically generated here -->
            </div>
            
            <div class="challenge-buttons">
                <button class="challenge-btn submit-btn" id="submitBtn" disabled>Submit Answer</button>
                <button class="challenge-btn next-btn" id="nextBtn" style="display: none;">Next Question</button>
            </div>
            
            <div class="results-container" id="resultsContainer" style="display: none;">
                <div class="score-display" id="scoreDisplay"></div>
                <div class="points-earned" id="pointsEarned"></div>
                
                <!-- Badge display for passed challenges -->
                <div class="badge-container" id="badgeContainer" style="display: none;">
                    <div class="badge-display">
                        <img src="../../../../assets/b1.png" alt="Episode 1 Badge" class="badge-image">
                        <div class="badge-text">
                            <h3>CONGRATULATIONS!</h3>
                            <p>You've earned the Episode 1 Badge!</p>
                        </div>
                        <!-- <button class="challenge-btn badge-ok-btn" id="badgeOkBtn">OK</button> -->
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
                    <button class="challenge-btn end-episode-btn" id="endEpisodeBtn">END EPISODE 1 - GAIN POINTS</button>
                    <button class="challenge-btn exit-btn" id="exitBtn">EXIT TO HOMEPAGE</button>
                </div>
            </div>
        </div>
    </div>
    <div class="intro-screen" id="introScreen">
        <div class="intro-text-container">
            <p class="intro-main-text" id="introMainText"></p>
        </div>
        <p class="intro-next-text" id="introNextText"></p>
    </div>

    <div class="chapter-intro-screen" id="chapterIntroScreen">
        <div class="chapter-text-container">
            <p class="chapter-main-text">Chapter 1</p>
            <p class="episode-sub-text" id="episodeSubText">Episode 1</p>
        </div>
    </div>

    <div class="scene-container" id="sceneContainer">
        <img src="" alt="Scene Content" class="scene-content" id="sceneImage" style="display: none;">
        <video src="" class="scene-content" id="sceneVideo" autoplay muted style="display: none;"></video>
        <div class="scene-text-overlay" id="sceneTextOverlay" style="display: none;"></div>
        <div class="subtitle-container" id="subtitleContainer"></div>
        <p class="scene-next-text" id="sceneNextText"></p>
    </div>

    <script>
        const introScreen = document.getElementById('introScreen');
        const introMainText = document.getElementById('introMainText');
        const introNextText = document.getElementById('introNextText');
        const chapterIntroScreen = document.getElementById('chapterIntroScreen');
        const episodeSubText = document.getElementById('episodeSubText');

        const sceneContainer = document.getElementById('sceneContainer');
        const sceneImage = document.getElementById('sceneImage');
        const sceneVideo = document.getElementById('sceneVideo');
        const sceneTextOverlay = document.getElementById('sceneTextOverlay');
        const subtitleContainer = document.getElementById('subtitleContainer');
        const sceneNextText = document.getElementById('sceneNextText');

        const introTexts = [
            "In a land where old legends meet modern minds...",
            "Where the spirit of Filipinos echoes through every line of code...",
            "A new generation rises not with blades, but with logic, syntax, and heart.",
            "You are one of them...",
            "A Code-Tropa.",
            "Guided by the algorithms of wisdom, the rhythm of real-world problems, and the fire of your curiosity...",
            "Your mission: Learn. Solve. Build.",
            "The digital realm is stirring... and only those who understand the code can restore the balance.",
            "Handa ka na ba?",
        ];
        let currentIntroTextIndex = 0;

        const scenes = [
            { type: 'video', src: 'assets/1.mp4', subtitle: 'Axle: Hala, bilisan niyo!' },
            { type: 'video', src: 'assets/2.mp4', subtitle: "Axle:Hmm? Ang ingay naman sa labas... Araw ng linggo 'di ba?" },
            { type: 'video', src: 'assets/3.mp4', subtitle: '' },
            { type: 'video', src: 'assets/4.mp4', subtitle: '' },
            { type: 'video', src: 'assets/5.mp4', subtitle: 'Maaga pa lang ay gising na ang buong barangay. Ang bawat sulok ng kalsada ay may kulay at galaw... parang buong baryo ay sabay-sabay nagising.' },
            { type: 'video', src: 'assets/6.mp4', subtitle: 'Lumabas si axle at sinalubong ni Tita Melba' },
            { type: 'video', src: 'assets/7.mp4', subtitle: 'Tita Melba: Ay, gising na ang binata! Axle, kumain ka na dito doon sa pista.' },
            { type: 'video', src: 'assets/8.mp4', subtitle: 'Axle: Ah.. sige lang po!'},
            { type: 'video', src: 'assets/8.mp4', subtitle: [
                'Axle: Grabe, parang buong barangay naghahanda...',
                'Pero ang saya rin.',
                'Kung ganito lang sana kadali ang programming...'
            ]},
            { type: 'video', src: 'assets/9.mp4', subtitle: 'Axle: Kuya Justin! Andito ka pala. Kakauwi mo lang ba?' },
            { type: 'video', src: 'assets/9.mp4', subtitle: 'Justin: Oo, kararating lang kahapon. Tinulungan ko lang sila mag-setup ng sound system kanina.' },
            { type: 'video', src: 'assets/10.mp4', subtitle: 'Axle: Ah, Kuya… tanong ko lang. Sa course ko kasi may Java agad. Eh… honestly, wala talaga akong alam sa programming. Gusto ko lang sana mag-practice habang bakasyon...' },
            { type: 'video', src: 'assets/11.mp4', subtitle: 'Justin: Ganon? Sige, may dala akong laptop.' },
            { type: 'image', src: 'assets/12.png', subtitle: 'Justin: Gusto mo, turuan kita basics habang nagpapahinga tayo? Basic syntax muna.' },
            { type: 'image', src: 'assets/12.png', subtitle: 'Axle: Game ako d’yan! Baka sakto, magets ko rin sa wakas.' },
            { type: 'image', src: 'assets/laptop.png', subtitle: 'Justin: Okay, ganito muna. Sa Java, ang pinaka-basic na kailangan mong tandaan ay yung structure. Para kang gumagawa ng script na sinusunod ng computer.' },
            { type: 'image', src: 'assets/laptop.png', content: '<pre>public class HelloWorld {<br><br>}</pre>', subtitle: 'Justin: Ito ang "class". Parang container ng buong program mo. Ang pangalan nito dapat tugma sa filename.'  },
            { type: 'image', src: 'assets/laptop.png', content: 'public class HelloWorld {<br><pre>&emsp;public static void main(String[] args) {<br><br>&emsp;}</pre><br>}', subtitle: 'Justin: "main" naman ang pinaka-entrance. Pag run mo ng Java program, ito agad ang hinahanap ng computer.'  },
            { type: 'image', src: 'assets/laptop.png', content: 'public class HelloWorld {<br>&emsp;public static void main(String[] args) {<br><pre>&emsp;&emsp;System.out.println("Hello, Axle!");</pre><br>&emsp;<br>&emsp;}<br>}', 
            subtitle: 'Justin: "System.out.println" naman ang ginagamit para makapag print.'  },
            { type: 'image', src: 'assets/laptop.png', content: 'public class HelloWorld {<br>&emsp;public static void main(String[] args) {<br>&emsp;&emsp;System.out.println("Hello, Axle!");<br>&emsp;<br>&emsp;}<br>}', 
            subtitle: 'Justin: Kailangan ng semicolon “;” kada statement, parang period. At yung mga braces “{}” parang box, nagsasabi kung saan nagsisimula at nagtatapos ang block ng code.'  },
            { type: 'image', src: 'assets/12.png', subtitle: 'Axle: Sige kuya maraming salamat. Sa susunod uli' },
        ];
        let currentSceneIndex = 0;
        let currentSubtitleIndex = 0; // New: to track current subtitle sentence
        let typingInterval = null; // For typing animation

        // Challenge variables
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let totalScore = 0;
        let challengeStarted = false;

        // Quiz data
        const quizQuestions = [
            {
                question: "What is the correct way to print a message in Java?",
                options: [
                    "Console.log(\"Hello!\");",
                    "System.out.println(\"Hello!\");",
                    "print(\"Hello!\");",
                    "Write(\"Hello!\");"
                ],
                correct: 1
            },
            {
                question: "Which method is the entry point of a Java program?",
                options: [
                    "start()",
                    "main()",
                    "init()",
                    "launch()"
                ],
                correct: 1
            },
            {
                question: "Which symbol is used to end a statement in Java?",
                options: [
                    ":",
                    ";",
                    ".",
                    "#"
                ],
                correct: 1
            },
            {
                question: "What is the correct class declaration syntax in Java?",
                options: [
                    "function HelloWorld {}",
                    "public HelloWorld class {}",
                    "class HelloWorld {}",
                    "HelloWorld class()"
                ],
                correct: 2
            },
            {
                question: "How do you start a comment in Java?",
                options: [
                    "##",
                    "<!-- -->",
                    "//",
                    "**"
                ],
                correct: 2
            }
        ];





        function showIntroText() {
            if (currentIntroTextIndex < introTexts.length) {
                introMainText.classList.remove('show');
                introNextText.classList.remove('show');

                setTimeout(() => {
                    introMainText.textContent = introTexts[currentIntroTextIndex];
                    introMainText.classList.add('show');
                    if (currentIntroTextIndex < introTexts.length - 1) {
                        introNextText.textContent = "Click to Next";
                        introNextText.classList.add('show');
                    } else {
                        introNextText.textContent = "Click to Start"; // Last message
                        introNextText.classList.add('show');
                    }
                }, 500);
            } else {
                // All texts shown, fade out intro screen and show chapter intro
                introScreen.style.opacity = '0';
                introScreen.addEventListener('transitionend', () => {
                    introScreen.style.visibility = 'hidden';
                    showChapterIntro(); // Call function to show chapter intro
                }, { once: true });
            }
        }

        function showChapterIntro() {
            chapterIntroScreen.style.opacity = '1';
            chapterIntroScreen.style.visibility = 'visible';
            setTimeout(() => {
                hideChapterIntro(); // Automatically hide after 3 seconds
            }, 1500); // 3000 milliseconds = 3 seconds
        }

        function hideChapterIntro() {
            chapterIntroScreen.style.opacity = '0';
            chapterIntroScreen.addEventListener('transitionend', () => {
                chapterIntroScreen.style.visibility = 'hidden';
                showScene(0); // Start showing the first scene
            }, { once: true });
        }

        // Typing animation function for mixed content (only <pre> tags type)
        function typeText(element, text, speed = 50) {
            // Clear any existing typing animation
            if (typingInterval) {
                clearInterval(typingInterval);
            }
            
            // Split content into parts: before <pre>, <pre> content, after </pre>
            const preStart = text.indexOf('<pre>');
            const preEnd = text.indexOf('</pre>');
            
            if (preStart === -1 || preEnd === -1) {
                // No <pre> tags found, just display normally
                element.innerHTML = text;
                return;
            }
            
            const beforePre = text.substring(0, preStart);
            const preContent = text.substring(preStart, preEnd + 6); // Include </pre>
            const afterPre = text.substring(preEnd + 6);
            
            // Display the non-<pre> content immediately
            element.innerHTML = beforePre;
            
            // Start typing the <pre> content
            let i = 0;
            const fullPreContent = preContent;
            
            typingInterval = setInterval(() => {
                if (i < fullPreContent.length) {
                    // Handle HTML entities (like &emsp;)
                    if (fullPreContent[i] === '&') {
                        let entityEnd = fullPreContent.indexOf(';', i);
                        if (entityEnd !== -1) {
                            element.innerHTML += fullPreContent.substring(i, entityEnd + 1);
                            i = entityEnd + 1;
                        } else {
                            element.innerHTML += fullPreContent[i];
                            i++;
                        }
                    }
                    // Handle HTML tags
                    else if (fullPreContent[i] === '<') {
                        let tagEnd = fullPreContent.indexOf('>', i);
                        if (tagEnd !== -1) {
                            element.innerHTML += fullPreContent.substring(i, tagEnd + 1);
                            i = tagEnd + 1;
                        } else {
                            element.innerHTML += fullPreContent[i];
                            i++;
                        }
                    } else {
                        element.innerHTML += fullPreContent[i];
                        i++;
                    }
                } else {
                    // Add the after-pre content and blinking cursor
                    element.innerHTML += afterPre + '<span class="typing-cursor"></span>';
                    clearInterval(typingInterval);
                    typingInterval = null;
                }
            }, speed);
        }

        function showScene(index) {
            if (index < scenes.length) {
                const scene = scenes[index];

                sceneImage.style.display = 'none';
                sceneVideo.style.display = 'none';
                sceneTextOverlay.style.display = 'none';
                sceneVideo.pause();
                sceneVideo.currentTime = 0;
                
                // Clear any existing typing animation
                if (typingInterval) {
                    clearInterval(typingInterval);
                    typingInterval = null;
                }
                
                // Clean up any captured frame from previous scene
                const capturedFrame = sceneContainer.querySelector('.captured-frame');
                if (capturedFrame) {
                    capturedFrame.style.display = 'none';
                }

                if (scene.type === 'image') {
                    sceneImage.src = scene.src;
                    sceneImage.style.display = 'block';
                    
                    // Check if this image scene has content for text overlay
                    if (scene.content) {
                        sceneTextOverlay.style.display = 'block';
                        sceneTextOverlay.classList.add('show');
                        // Use typing animation only for <pre> tags
                        if (scene.content.includes('<pre>')) {
                            typeText(sceneTextOverlay, scene.content, 100);
                        } else {
                            sceneTextOverlay.innerHTML = scene.content;
                        }
                    }
                } else if (scene.type === 'video') {
                    sceneVideo.src = scene.src;
                    sceneVideo.style.display = 'block';
                    sceneVideo.play();
                } else if (scene.type === 'text') {
                    sceneTextOverlay.style.display = 'block';
                    sceneTextOverlay.classList.add('show');
                    // Use typing animation only for <pre> tags
                    if (scene.content.includes('<pre>')) {
                        typeText(sceneTextOverlay, scene.content, 100);
                    } else {
                        sceneTextOverlay.innerHTML = scene.content;
                    }
                }

                if (Array.isArray(scene.subtitle)) {
                    subtitleContainer.textContent = scene.subtitle.join('\n');
                } else {
                    subtitleContainer.textContent = scene.subtitle;
                }

                sceneContainer.style.opacity = '1';
                sceneContainer.style.visibility = 'visible';
                sceneNextText.classList.remove('show'); // Ensure it's hidden before deciding to show/highlight
                sceneNextText.classList.remove('highlight'); // Ensure highlight is removed initially

                // Show "Click to Next" text unless it's the last scene
                if (index < scenes.length - 1) {
                    sceneNextText.textContent = "Click to Next";
                } else {
                    sceneNextText.textContent = "Click to Start"; // Last scene
                }
                sceneNextText.classList.add('show');

                // Handle highlighting
                if (scene.type === 'image' || scene.type === 'text') {
                    sceneNextText.classList.add('highlight');
                } else if (scene.type === 'video') {
                    sceneNextText.classList.remove('highlight'); // Initially not highlighted
                    sceneVideo.onended = () => {
                        sceneNextText.classList.add('highlight'); // Highlight when video ends
                    };
                }

                // Add event listener to skip scene on click
                sceneContainer.onclick = () => {
                    sceneNextText.classList.remove('show'); // Hide text on click
                    sceneNextText.classList.remove('highlight'); // Remove highlight on click
                    currentSceneIndex++;
                    showScene(currentSceneIndex);
                };

                // For video, also listen for 'ended' event to advance scene automatically
                /*
                if (scene.type === 'video') {
                    sceneVideo.onended = () => {
                        currentSceneIndex++;
                        showScene(currentSceneIndex);
                    };
                }
                */
            } else {
                // All scenes shown, hide scene container and show challenge
                sceneContainer.style.opacity = '0';
                sceneContainer.addEventListener('transitionend', () => {
                    sceneContainer.style.visibility = 'hidden';
                    // Show challenge after all scenes are completed
                    console.log("All scenes completed! Starting challenge...");
                    showChallenge();
                }, { once: true });
            }
        }

        introScreen.addEventListener('click', () => {
            currentIntroTextIndex++;
            showIntroText();
        });

        // Initial call to display the first intro text
        document.addEventListener('DOMContentLoaded', showIntroText);

        // Challenge functions
        function showChallenge() {
            const challengeContainer = document.getElementById('challengeContainer');
            const mainBg = document.querySelector('.main-bg');
            challengeContainer.classList.add('show');
            mainBg.classList.add('show');
            displayQuestion(0);
        }

        function displayQuestion(questionIndex) {
            const questionsContainer = document.getElementById('questionsContainer');
            const question = quizQuestions[questionIndex];
            
            questionsContainer.innerHTML = `
                <div class="question-container">
                    <div class="question-number">Question ${questionIndex + 1}:</div>
                    <div class="question-text">${question.question}</div>
                    <div class="options-container">
                        ${question.options.map((option, index) => `
                            <div class="option" data-index="${index}">
                                <span class="option-letter">${String.fromCharCode(65 + index)}.</span>
                                <span>${option}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Add click listeners to options
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove previous selection
                    document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                    // Add selection to clicked option
                    this.classList.add('selected');
                    // Enable submit button
                    document.getElementById('submitBtn').disabled = false;
                });
            });

            // Reset buttons
            const submitBtn = document.getElementById('submitBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            submitBtn.disabled = true;
            submitBtn.style.display = 'inline-block';
            nextBtn.disabled = false;
            nextBtn.style.display = 'none';
            
            // Always show "Submit Answer" for all questions
            submitBtn.textContent = 'Submit Answer';
        }

        function submitAnswer() {
            const selectedOption = document.querySelector('.option.selected');
            if (!selectedOption) return;

            const selectedIndex = parseInt(selectedOption.dataset.index);
            const question = quizQuestions[currentQuestionIndex];
            const isCorrect = selectedIndex === question.correct;

            // Store answer
            userAnswers[currentQuestionIndex] = selectedIndex;

            // Show correct/incorrect feedback
            document.querySelectorAll('.option').forEach((option, index) => {
                option.classList.remove('selected');
                if (index === question.correct) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });

            // Update score
            if (isCorrect) {
                totalScore += 20;
            }

            // Show next button or results
            document.getElementById('submitBtn').style.display = 'none';
            if (currentQuestionIndex < quizQuestions.length - 1) {
                document.getElementById('nextBtn').style.display = 'inline-block';
            } else {
                showResults();
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                displayQuestion(currentQuestionIndex);
            }
        }

        function showResults() {
            const questionsContainer = document.getElementById('questionsContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const pointsEarned = document.getElementById('pointsEarned');

            questionsContainer.style.display = 'none';
            document.querySelector('.challenge-buttons').style.display = 'none';
            resultsContainer.style.display = 'block';

            const hasPassed = totalScore >= 80;
            
            if (hasPassed) {
                scoreDisplay.textContent = `🎉 PASSED! Score: ${totalScore}/100`;
                scoreDisplay.style.color = '#4CAF50';
                pointsEarned.textContent = `You earned ${totalScore} points!`;
                
                // Show badge for passed challenge
                document.getElementById('badgeContainer').style.display = 'flex';
                
                document.getElementById('endEpisodeBtn').textContent = 'NEXT EPISODE';
                document.getElementById('endEpisodeBtn').style.backgroundColor = '#4CAF50';

                // Award badge in database (tier=t1, badgeName=b1)
                fetch('../../../../../2be/award_badge.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `tier=${encodeURIComponent('t1')}&badgeName=${encodeURIComponent('b1')}`
                })
                .then(r => r.json())
                .then(data => {
                    console.log('Award badge response:', data);
                })
                .catch(err => {
                    console.error('Failed to award badge:', err);
                });
            } else {
                scoreDisplay.textContent = `❌ FAILED! Score: ${totalScore}/100`;
                scoreDisplay.style.color = '#f44336';
                pointsEarned.textContent = `You need 80+ points to pass. Try again!`;
                
                // Hide badge for failed challenge
                document.getElementById('badgeContainer').style.display = 'none';
                
                document.getElementById('endEpisodeBtn').textContent = 'RETRY EPISODE';
                document.getElementById('endEpisodeBtn').style.backgroundColor = '#FF9800';
            }

            // Save progress to database
            saveStoryProgress(totalScore, hasPassed);
        }

        function endEpisode() {
            const hasPassed = totalScore >= 80;
            
            if (hasPassed) {
                // Go to next episode (Episode 2)
                window.location.href = '../ep2/index.html';
            } else {
                // Retry current episode
                retryEpisode();
            }
        }

        function retryEpisode() {
            // Reset all variables
            currentQuestionIndex = 0;
            userAnswers = [];
            totalScore = 0;
            challengeStarted = false;

            // Hide results and show challenge again
            const resultsContainer = document.getElementById('resultsContainer');
            const challengeContainer = document.getElementById('challengeContainer');
            
            resultsContainer.style.display = 'none';
            document.querySelector('.challenge-buttons').style.display = 'flex';
            
            // Hide badge
            document.getElementById('badgeContainer').style.display = 'none';
            
            // Reset button text and color
            document.getElementById('endEpisodeBtn').textContent = 'END EPISODE 1 - GAIN POINTS';
            document.getElementById('endEpisodeBtn').style.backgroundColor = '#FF9800';
            
            // Start challenge again
            displayQuestion(0);
        }

        function saveStoryProgress(score, hasPassed) {
            // Save story progress to database
            const progressData = {
                type: 'story',
                language: 'java', // This should be dynamic based on current language
                chapter: 1,
                episode: 1,
                points: score,
                passed: hasPassed
            };

            fetch('../../../../../2be/save_story_progress.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `type=${encodeURIComponent(progressData.type)}&language=${encodeURIComponent(progressData.language)}&chapter=${encodeURIComponent(progressData.chapter)}&episode=${encodeURIComponent(progressData.episode)}&points=${encodeURIComponent(progressData.points)}&passed=${encodeURIComponent(progressData.passed)}`
            }).then(r => r.json()).then(data => {
                console.log('Story progress saved:', data);
                
                // Save performance data if progress was saved successfully
                if (data.success && data.progressId) {
                    const performanceData = {
                        progressId: data.progressId,
                        accuracy: score >= 80 ? 100 : 0, // Simple accuracy based on pass/fail
                        efficiency: score >= 80 ? 100 : 0, // Simple efficiency based on pass/fail
                        readability: score >= 80 ? 100 : 0, // Simple readability based on pass/fail
                        timeTaken: 0, // Story mode doesn't track time yet
                        success: hasPassed ? 1 : 0,
                        failed: hasPassed ? 0 : 1
                    };
                    
                    console.log('=== SAVING STORY PERFORMANCE DEBUG ===');
                    console.log('Performance data:', performanceData);
                    
                    fetch('../../../../../2be/save_performance.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `progressId=${encodeURIComponent(performanceData.progressId)}&accuracy=${encodeURIComponent(performanceData.accuracy)}&efficiency=${encodeURIComponent(performanceData.efficiency)}&readability=${encodeURIComponent(performanceData.readability)}&timeTaken=${encodeURIComponent(performanceData.timeTaken)}&success=${encodeURIComponent(performanceData.success)}&failed=${encodeURIComponent(performanceData.failed)}`
                    }).then(perfResponse => {
                        console.log('Save story performance response status:', perfResponse.status);
                        return perfResponse.json();
                    }).then(perfData => {
                        console.log('Save story performance response data:', perfData);
                    }).catch(perfErr => {
                        console.error('Save story performance network error:', perfErr);
                    });
                    console.log('=== END SAVING STORY PERFORMANCE DEBUG ===');
                }
            }).catch(err => {
                console.error('Error saving story progress:', err);
            });
        }

        function exitToHomepage() {
            // Hide background before redirecting
            const mainBg = document.querySelector('.main-bg');
            mainBg.classList.remove('show');
            // Redirect back to homepage
            window.location.href = '../../../index.html';
        }

        // Add event listeners for challenge buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('submitBtn').addEventListener('click', submitAnswer);
            document.getElementById('nextBtn').addEventListener('click', nextQuestion);
            document.getElementById('endEpisodeBtn').addEventListener('click', endEpisode);
            document.getElementById('exitBtn').addEventListener('click', exitToHomepage);
            document.getElementById('badgeOkBtn').addEventListener('click', function() {
                // Hide badge when OK is clicked
                document.getElementById('badgeContainer').style.display = 'none';
            });
        });

    </script>




    <!-- <div class="startBG">

        <h2>welcome</h2><br><br>
        <button onclick="location.href='../../'">exit</button>

    </div> -->

    
</body>
</html>
